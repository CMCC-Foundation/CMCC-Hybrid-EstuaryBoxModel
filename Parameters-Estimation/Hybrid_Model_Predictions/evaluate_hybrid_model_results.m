%% Add to path subdirectory
addpath(genpath('..\..\Machine-Learning-Tools\1-Utility'));
addpath(genpath('..\..\Machine-Learning-Tools\3-Plot-Figure'));

%% Set import dataset settings
% load training dataset
filepath = "salinity_dataset_hybrid_model_predictions.xlsx";
nVars = 15;
dataRange = "A2:O1462";
sheetName = "hybrid_predictions";
varNames = ["Year","Doy","Qriver", "Qtide", "Qll", "Socean", "Sll",...
    "SalinityObserved", "EBM_Predictions", "RF_Predictions", "LSBoost_Predictions",...
    "NN_Predictions", "Hybrid_RF_EBM","Hybrid_LSBoost_EBM","Dataset"]; 

varTypes = ["int16","int16","double", "double", "double", "double","double",...
    "double","double","double","double","double","double","double","categorical"];

[salinity_predictions] = import_dataset(filepath, nVars, dataRange, sheetName, varNames, varTypes);

salinity_training_predictions = salinity_predictions(salinity_predictions.Dataset == "Training", ...
    ["SalinityObserved","EBM_Predictions","RF_Predictions","LSBoost_Predictions",...
    "NN_Predictions","Hybrid_RF_EBM","Hybrid_LSBoost_EBM"]);

salinity_test_predictions = salinity_predictions(salinity_predictions.Dataset == "Test", ...
    ["SalinityObserved","EBM_Predictions","RF_Predictions","LSBoost_Predictions",...
    "NN_Predictions","Hybrid_RF_EBM","Hybrid_LSBoost_EBM"]);

results = table('Size', [6 3], ...
    'VariableTypes', {'double','double','double'}, ...
    'VariableNames', {'RMSE', 'MAE','Corr_Coeff'},...
    'RowNames', {'ebm_train','ebm_test','Hybrid_RF_train','Hybrid_RF_test',...
    'Hybrid_LSBoost_train','Hybrid_LSBoost_test'});


%% ebm model metrics
% EBM TRAIN
results.RMSE(1) = computeRMSE( ...
    salinity_training_predictions.SalinityObserved, ...
    salinity_training_predictions.EBM_Predictions);

results.MAE(1) = computeMAE( ...
    salinity_training_predictions.SalinityObserved, ...
    salinity_training_predictions.EBM_Predictions);

results.Corr_Coeff(1) = computeCorrCoef( ...
    salinity_training_predictions.SalinityObserved, ...
    salinity_training_predictions.EBM_Predictions);

% EBM TEST
results.RMSE(2) = computeRMSE( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.EBM_Predictions);

results.MAE(2) = computeMAE( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.EBM_Predictions);

results.Corr_Coeff(2) = computeCorrCoef( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.EBM_Predictions);

%% hybrid RF model metrics
% hybrid train
results.RMSE(3) = computeRMSE( ...
    salinity_training_predictions.SalinityObserved, ...
    salinity_training_predictions.Hybrid_RF_EBM);

results.MAE(3) = computeMAE( ...
    salinity_training_predictions.SalinityObserved, ...
    salinity_training_predictions.Hybrid_RF_EBM);

results.Corr_Coeff(3) = computeCorrCoef( ...
    salinity_training_predictions.SalinityObserved, ...
    salinity_training_predictions.Hybrid_RF_EBM);

% hybrid test
results.RMSE(4) = computeRMSE( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.Hybrid_RF_EBM);

results.MAE(4) = computeMAE( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.Hybrid_RF_EBM);

results.Corr_Coeff(4) = computeCorrCoef( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.Hybrid_RF_EBM);


%% hybrid LSBoost model metrics
% hybrid train
results.RMSE(5) = computeRMSE( ...
    salinity_training_predictions.SalinityObserved, ...
    salinity_training_predictions.Hybrid_LSBoost_EBM);

results.MAE(5) = computeMAE( ...
    salinity_training_predictions.SalinityObserved, ...
    salinity_training_predictions.Hybrid_LSBoost_EBM);

results.Corr_Coeff(5) = computeCorrCoef( ...
    salinity_training_predictions.SalinityObserved, ...
    salinity_training_predictions.Hybrid_LSBoost_EBM);

% hybrid test
results.RMSE(6) = computeRMSE( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.Hybrid_LSBoost_EBM);

results.MAE(6) = computeMAE( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.Hybrid_LSBoost_EBM);

results.Corr_Coeff(6) = computeCorrCoef( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.Hybrid_LSBoost_EBM);

%% PWB table
algorithm_names = {'EBM','Hybrid_RF_EBM', 'Hybrid_LSBoost_EBM'};
pwbX = [1 5 10 20 30];
pwbXRowNames = string();

for i = 1:numel(pwbX)
    pwbXRowNames(i) = strcat('PWB', num2str(pwbX(i)));
end

pwbTable = table('Size',[numel(pwbX) numel(algorithm_names)],...
    'VariableTypes', repmat({'double'}, 1, numel(algorithm_names)), ...
    'VariableNames', algorithm_names,...
    'RowNames', pwbXRowNames);

% ebm
pwbTable = create_pwb_table( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.EBM_Predictions,...
    pwbTable, ...
    algorithm_names(1), ...
    pwbX);

% RF+EBM
pwbTable = create_pwb_table( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.Hybrid_RF_EBM,...
    pwbTable, ...
    algorithm_names(2), ...
    pwbX);

% LSBoost+EBM
pwbTable = create_pwb_table( ...
    salinity_test_predictions.SalinityObserved, ...
    salinity_test_predictions.Hybrid_LSBoost_EBM,...
    pwbTable, ...
    algorithm_names(3), ...
    pwbX);

disp(results(["ebm_test","Hybrid_RF_test", "Hybrid_LSBoost_test"],:))
disp(pwbTable)

%% Plot result
algorithm_names = {'EBM','Hybrid-RF-EBM', 'Hybrid-LSBoost-EBM'};
response = 'SalinityObserved';

% Training dataset
training_table_results = array2table([ ...
    salinity_training_predictions.SalinityObserved ...
    salinity_training_predictions.EBM_Predictions...
    salinity_training_predictions.Hybrid_RF_EBM ...
    salinity_training_predictions.Hybrid_LSBoost_EBM ...
],"VariableNames",{'real_sal','ebm_pred','hybrid_rf_pred','hybrid_lsb_pred'});

test_table_results = array2table([ ...
    salinity_test_predictions.SalinityObserved ...
    salinity_test_predictions.EBM_Predictions...
    salinity_test_predictions.Hybrid_RF_EBM...
    salinity_test_predictions.Hybrid_LSBoost_EBM...
    ],"VariableNames",{'real_sal','ebm_pred','hybrid_rf_pred','hybrid_lsb_pred'});

create_perfect_fit(test_table_results,algorithm_names,true,30);
create_residuals_plot(test_table_results,algorithm_names,response);

%% Save result
writetable(results,"metrics_hybrid_models.xlsx","WriteRowNames",true);
writetable(pwbTable,"pwb_hybrid_models.xlsx","WriteRowNames",true);

%% Function definition
function [rmse] = computeRMSE(obs, pred)
    rmse = sqrt(sum((obs - pred).^2)/height(obs));
end

function [mae] = computeMAE(obs, pred)
    mae = (sum(abs(pred-obs)))/height(obs);
end

function [r] = computeCorrCoef(obs, pred)
    corr_coeff_matrix = corrcoef(obs, pred);
    r = corr_coeff_matrix(1,2);
end